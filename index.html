import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  onSnapshot, 
  query, 
  orderBy, 
  updateDoc, 
  doc, 
  deleteDoc, 
  serverTimestamp,
  getDocs
} from 'firebase/firestore';
import { 
  Flame, 
  ChefHat, 
  PlusCircle, 
  CheckCircle2, 
  Clock, 
  Trash2, 
  ChevronRight,
  ShoppingCart,
  X,
  CreditCard,
  Receipt,
  Smartphone,
  Wallet,
  Archive,
  Send,
  Tag,
  Zap,
  Split,
  BellRing,
  UtensilsCrossed,
  Info,
  Download,
  Share2,
  Coins,
  MessageSquareText,
  Plus,
  MapPin,
  Printer,
  Bike,
  Truck,
  MessageCircle,
  BarChart3,
  CalendarDays,
  ClipboardList
} from 'lucide-react';

// Firebase Config
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'braza-brava-v1';

const SOUND_NUEVO_PEDIDO = 'https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3';
const SOUND_PEDIDO_LISTO = 'https://assets.mixkit.co/active_storage/sfx/2357/2357-preview.mp3';

const MENU_CATEGORIES = [
  { id: 'hamburguesas', name: 'Hamburguesas', items: [{ name: 'Sencilla Brava', price: 15000 }, { name: 'Doble Braza', price: 22000 }, { name: 'Pollo Grill', price: 18000 }] },
  { id: 'perros_vapor', name: 'Perros al Vapor', items: [{ name: 'Sencillo Vapor', price: 10000 }, { name: 'Suizo Vapor', price: 14000 }] },
  { id: 'perros_carbon', name: 'Perros al CarbÃ³n', items: [{ name: 'Sencillo CarbÃ³n', price: 12000 }, { name: 'Especial CarbÃ³n', price: 16000 }] },
  { id: 'salchipapas', name: 'Salchipapas', items: [{ name: 'Salchi Sencilla', price: 12000 }, { name: 'La Brava Mix', price: 28000 }] },
  { id: 'asados', name: 'Asados', items: [{ name: 'Carne Asada', price: 25000 }, { name: 'Pechuga CarbÃ³n', price: 22000 }, { name: 'Churrasco', price: 35000 }] },
  { id: 'bebidas', name: 'Bebidas', items: [{ name: 'Gaseosa 350ml', price: 4000 }, { name: 'Jugo Natural', price: 6000 }] }
];

const MESAS = Array.from({ length: 15 }, (_, i) => i + 1);

export default function App() {
  const [view, setView] = useState('cliente');
  const [user, setUser] = useState(null);
  const [pedidos, setPedidos] = useState([]);
  const [serviceType, setServiceType] = useState('local');
  const [selectedMesa, setSelectedMesa] = useState('1');
  const [destinoData, setDestinoData] = useState({ direccion: '', costoEnvio: 0 });
  const [cart, setCart] = useState([]);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [showCartMobile, setShowCartMobile] = useState(false);
  
  const audioNuevoRef = useRef(null);
  const audioListoRef = useRef(null);
  const prevCount = useRef({ pendientes: 0, listos: 0 });

  const [payingOrder, setPayingOrder] = useState(null);
  const [stepPayment, setStepPayment] = useState('verify'); 
  const [tipAmount, setTipAmount] = useState(0);
  const [cashReceived, setCashReceived] = useState('');
  const [isSplitPayment, setIsSplitPayment] = useState(false);
  const [splitCashAmount, setSplitCashAmount] = useState(0);
  const [showZReport, setShowZReport] = useState(false);
  const [cajaBase, setCajaBase] = useState(100000); 
  const [zComments, setZComments] = useState('');

  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (error) { console.error(error); }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, setUser);
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    const path = collection(db, 'artifacts', appId, 'public', 'data', 'pedidos');
    const unsubscribe = onSnapshot(path, (snapshot) => {
      const docs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      const sorted = docs.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
      
      const currentPendientes = docs.filter(p => p.estado === 'Pendiente').length;
      const currentListos = docs.filter(p => p.estado === 'Listo' && p.pagoEstado === 'Pendiente').length;

      if (currentPendientes > prevCount.current.pendientes) audioNuevoRef.current?.play().catch(() => {});
      if (currentListos > prevCount.current.listos) audioListoRef.current?.play().catch(() => {});

      prevCount.current = { pendientes: currentPendientes, listos: currentListos };
      setPedidos(sorted);
    }, (err) => console.error(err));
    return () => unsubscribe();
  }, [user]);

  const addToCart = (product) => {
    setCart(prev => [...prev, { ...product, qty: 1, notes: '', tempId: crypto.randomUUID() }]);
  };

  const removeFromCart = (tempId) => setCart(prev => prev.filter(item => item.tempId !== tempId));
  const updateCartQty = (tempId, delta) => setCart(prev => prev.map(item => item.tempId === tempId ? { ...item, qty: Math.max(1, item.qty + delta) } : item));
  const updateCartNotes = (tempId, notes) => setCart(prev => prev.map(item => item.tempId === tempId ? { ...item, notes } : item));
  
  const calculateTotal = () => cart.reduce((acc, item) => acc + (item.price * item.qty), 0);

  const enviarPedidoCompleto = async () => {
    if (cart.length === 0) return;
    setIsSubmitting(true);
    try {
      const pedidosPath = collection(db, 'artifacts', appId, 'public', 'data', 'pedidos');
      const pedidoExistente = (serviceType === 'local') ? pedidos.find(p => 
        p.pagoEstado === 'Pendiente' && p.tipo === 'local' && p.mesa === selectedMesa
      ) : null;

      if (pedidoExistente) {
        const nuevosItems = [...pedidoExistente.items, ...cart];
        const nuevoTotal = nuevosItems.reduce((acc, item) => acc + (item.price * item.qty), 0);
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pedidos', pedidoExistente.id), {
          items: nuevosItems,
          total: nuevoTotal,
          estado: 'Pendiente'
        });
      } else {
        await addDoc(pedidosPath, {
          items: cart,
          tipo: serviceType,
          mesa: serviceType === 'local' ? selectedMesa : null,
          destino: serviceType !== 'local' ? destinoData.direccion : null,
          costoEnvio: serviceType === 'domicilio' ? (Number(destinoData.costoEnvio) || 0) : 0,
          total: calculateTotal(),
          estado: 'Pendiente',
          pagoEstado: 'Pendiente',
          timestamp: serverTimestamp(),
        });
      }

      setCart([]);
      setDestinoData({ direccion: '', costoEnvio: 0 });
      setShowCartMobile(false);
    } catch (e) { console.error(e); } finally { setIsSubmitting(false); }
  };

  const procesarPago = async (id, metodo, splitData = null) => {
    const finalTotal = payingOrder.total + tipAmount + (payingOrder.costoEnvio || 0);
    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pedidos', id), { 
      pagoEstado: 'Pagado',
      metodoPago: metodo,
      propina: tipAmount,
      totalFinal: finalTotal,
      fechaPago: serverTimestamp(),
      pagoCombinado: splitData
    });
    setPayingOrder(null);
    setStepPayment('verify');
    setCashReceived('');
    setTipAmount(0);
    setIsSplitPayment(false);
  };

  const formatPrice = (p) => new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', maximumFractionDigits: 0 }).format(p);

  const getDetalleCierre = () => {
    const pagados = pedidos.filter(p => p.pagoEstado === 'Pagado');
    
    const efectivo = pagados.reduce((acc, p) => {
      if (p.metodoPago === 'Efectivo') return acc + (p.totalFinal || p.total);
      if (p.metodoPago === 'Combinado') return acc + (p.pagoCombinado?.efectivo || 0);
      return acc;
    }, 0);

    const tarjeta = pagados.reduce((acc, p) => {
      if (p.metodoPago === 'Tarjeta') return acc + (p.totalFinal || p.total);
      if (p.metodoPago === 'Combinado' && p.pagoCombinado?.otro === 'Tarjeta') return acc + ((p.totalFinal || p.total) - p.pagoCombinado.efectivo);
      return acc;
    }, 0);

    const transferencia = pagados.reduce((acc, p) => {
      if (p.metodoPago === 'QR / Transferencia') return acc + (p.totalFinal || p.total);
      if (p.metodoPago === 'Combinado' && p.pagoCombinado?.otro === 'Transferencia') return acc + ((p.totalFinal || p.total) - p.pagoCombinado.efectivo);
      return acc;
    }, 0);

    const propinas = pagados.reduce((acc, p) => acc + (p.propina || 0), 0);
    const envios = pagados.reduce((acc, p) => acc + (p.costoEnvio || 0), 0);
    const totalVentasBrutas = pagados.reduce((acc, p) => acc + p.total, 0);

    const categoriasContador = {};
    pagados.forEach(p => {
      p.items.forEach(item => {
        const cat = MENU_CATEGORIES.find(c => c.items.some(i => i.name === item.name))?.name || 'Otros';
        categoriasContador[cat] = (categoriasContador[cat] || 0) + item.qty;
      });
    });

    return { efectivo, tarjeta, transferencia, propinas, envios, totalVentasBrutas, totalVentasNetas: totalVentasBrutas + propinas + envios, categoriasContador };
  };

  const enviarCierreWhatsApp = () => {
    const det = getDetalleCierre();
    const texto = `ðŸ”¥ *CIERRE DETALLADO - BRAZA BRAVA* ðŸ”¥%0A` +
      `ðŸ“… Fecha: ${new Date().toLocaleDateString()}%0A` +
      `--------------------------------%0A` +
      `ðŸ’° *RESUMEN DE CAJA*%0A` +
      `Base Inicial: ${formatPrice(cajaBase)}%0A` +
      `Ventas Efectivo: ${formatPrice(det.efectivo)}%0A` +
      `--------------------------------%0A` +
      `ðŸ’µ *TOTAL EN CAJA (Base + Efec): ${formatPrice(cajaBase + det.efectivo)}*%0A` +
      `--------------------------------%0A` +
      `ðŸ’³ *OTROS INGRESOS*%0A` +
      `Tarjetas: ${formatPrice(det.tarjeta)}%0A` +
      `Transferencias: ${formatPrice(det.transferencia)}%0A` +
      `--------------------------------%0A` +
      `âœ¨ *ADICIONALES*%0A` +
      `Propinas: ${formatPrice(det.propinas)}%0A` +
      `Domicilios: ${formatPrice(det.envios)}%0A` +
      `--------------------------------%0A` +
      `ðŸ“Š *VENTAS POR CATEGORÃA*%0A` +
      Object.entries(det.categoriasContador).map(([name, qty]) => `${name}: ${qty} unidades`).join('%0A') + `%0A` +
      `--------------------------------%0A` +
      `ðŸ“ˆ *VENTA TOTAL DEL TURNO: ${formatPrice(det.totalVentasNetas)}*%0A` +
      `--------------------------------%0A` +
      `ðŸ“ *COMENTARIOS:* ${zComments || 'Sin novedades'}`;
    
    window.open(`https://wa.me/?text=${texto}`, '_blank');
  };

  const renderCliente = () => {
    const mesaTienePedido = serviceType === 'local' && pedidos.some(p => p.pagoEstado === 'Pendiente' && p.tipo === 'local' && p.mesa === selectedMesa);

    return (
      <div className="max-w-4xl mx-auto px-4 pb-40 flex flex-col md:flex-row gap-8">
        <div className="flex-1">
          <header className="flex items-center justify-between my-6 bg-orange-600 p-6 rounded-3xl shadow-xl">
            <h1 className="text-2xl font-black italic flex items-center gap-2"><Flame className="fill-white" /> BRAZA BRAVA</h1>
            <div className="md:hidden relative" onClick={() => setShowCartMobile(!showCartMobile)}>
              <ShoppingCart size={24} />
              {cart.length > 0 && <span className="absolute -top-2 -right-2 bg-white text-orange-600 text-[10px] w-5 h-5 rounded-full flex items-center justify-center font-bold">{cart.length}</span>}
            </div>
          </header>

          <div className="bg-zinc-900 p-4 rounded-3xl mb-6 border border-zinc-800 space-y-4">
            <div className="grid grid-cols-3 gap-2">
              <button onClick={() => setServiceType('local')} className={`py-3 rounded-2xl font-black text-[10px] ${serviceType === 'local' ? 'bg-orange-500 text-white shadow-lg' : 'bg-zinc-800 text-zinc-500'}`}>LOCAL</button>
              <button onClick={() => setServiceType('llevar')} className={`py-3 rounded-2xl font-black text-[10px] ${serviceType === 'llevar' ? 'bg-orange-500 text-white shadow-lg' : 'bg-zinc-800 text-zinc-500'}`}>LLEVAR</button>
              <button onClick={() => setServiceType('domicilio')} className={`py-3 rounded-2xl font-black text-[10px] ${serviceType === 'domicilio' ? 'bg-orange-500 text-white shadow-lg' : 'bg-zinc-800 text-zinc-500'}`}>DOMICILIO</button>
            </div>
            
            {serviceType === 'local' ? (
              <div className="flex gap-2 overflow-x-auto py-2 scrollbar-hide">
                {MESAS.map(m => (
                  <button key={m} onClick={() => setSelectedMesa(m.toString())} className={`min-w-[44px] h-[44px] rounded-xl font-black text-xs transition-all relative ${selectedMesa === m.toString() ? 'bg-white text-orange-600' : 'bg-zinc-800 text-zinc-600'}`}>
                    {m} {pedidos.some(p => p.pagoEstado === 'Pendiente' && p.tipo === 'local' && p.mesa === m.toString()) && <span className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>}
                  </button>
                ))}
              </div>
            ) : (
              <div className="flex flex-col gap-3">
                <div className="flex items-center gap-3 bg-zinc-800/50 p-4 rounded-2xl border border-zinc-700">
                  <MapPin size={18} className="text-orange-500" />
                  <input type="text" placeholder="DirecciÃ³n o nombre del cliente" className="bg-transparent text-sm outline-none flex-1 text-white" value={destinoData.direccion} onChange={(e) => setDestinoData({...destinoData, direccion: e.target.value})} />
                </div>
                {serviceType === 'domicilio' && (
                  <div className="flex items-center gap-3 bg-zinc-800/50 p-4 rounded-2xl border border-zinc-700">
                    <Bike size={18} className="text-orange-500" />
                    <input type="number" placeholder="Costo de EnvÃ­o (Ej: 3000)" className="bg-transparent text-sm outline-none flex-1 text-white" value={destinoData.costoEnvio} onChange={(e) => setDestinoData({...destinoData, costoEnvio: e.target.value})} />
                  </div>
                )}
              </div>
            )}
          </div>

          <div className="space-y-8">
            {MENU_CATEGORIES.map(cat => (
              <div key={cat.id}>
                <h3 className="font-black text-[10px] uppercase tracking-widest mb-3 ml-2 flex items-center gap-2 text-orange-500"><UtensilsCrossed size={14}/> {cat.name}</h3>
                <div className="grid grid-cols-2 gap-3">
                  {cat.items.map(item => (
                    <button key={item.name} onClick={() => addToCart(item)} className="bg-zinc-900 border border-zinc-800 p-4 rounded-2xl flex flex-col items-start active:scale-95 transition-all text-left">
                      <span className="font-bold text-xs text-zinc-100 mb-1">{item.name}</span>
                      <span className="font-black text-xs text-orange-500">{formatPrice(item.price)}</span>
                    </button>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </div>

        <div className={`${showCartMobile ? 'fixed inset-0 z-[110] bg-black/95 p-4 flex items-center justify-center' : 'hidden'} md:block md:relative md:w-96 md:pt-6`}>
          <div className="bg-zinc-950 border border-zinc-800 rounded-[40px] p-6 w-full max-w-sm h-full max-h-[85vh] flex flex-col shadow-2xl">
            <div className="flex justify-between items-center mb-6">
              <h4 className="font-black italic text-xl uppercase tracking-tighter">{mesaTienePedido ? 'AdiciÃ³n' : 'Nueva Orden'}</h4>
              <button className="md:hidden bg-zinc-900 p-2 rounded-full" onClick={() => setShowCartMobile(false)}><X size={20}/></button>
            </div>
            
            <div className="flex-grow overflow-y-auto space-y-4 scrollbar-hide">
              {cart.map((item) => (
                <div key={item.tempId} className="bg-zinc-900/80 p-4 rounded-3xl border border-zinc-800">
                  <div className="flex justify-between font-bold text-xs mb-3">
                    <span>{item.name}</span>
                    <button onClick={() => removeFromCart(item.tempId)} className="text-zinc-500 hover:text-red-500"><Trash2 size={16}/></button>
                  </div>
                  <div className="flex items-center gap-2 mb-3 bg-black/30 p-2 rounded-xl border border-zinc-800/50">
                    <MessageSquareText size={14} className="text-zinc-500" />
                    <input type="text" placeholder="Notas..." className="bg-transparent text-[11px] outline-none flex-1 text-zinc-300" value={item.notes} onChange={(e) => updateCartNotes(item.tempId, e.target.value)} />
                  </div>
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3 bg-black/50 px-3 py-1 rounded-2xl border border-zinc-800">
                      <button onClick={() => updateCartQty(item.tempId, -1)} className="text-orange-500 font-black">-</button>
                      <span className="text-xs font-black">{item.qty}</span>
                      <button onClick={() => updateCartQty(item.tempId, 1)} className="text-orange-500 font-black">+</button>
                    </div>
                    <span className="text-zinc-400 font-bold text-xs">{formatPrice(item.price * item.qty)}</span>
                  </div>
                </div>
              ))}
            </div>

            <div className="mt-6 pt-6 border-t border-zinc-800">
              <div className="flex justify-between items-end mb-6">
                <span className="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Subtotal</span>
                <span className="text-3xl font-black text-white italic">{formatPrice(calculateTotal())}</span>
              </div>
              <button 
                disabled={cart.length === 0 || isSubmitting || (serviceType !== 'local' && !destinoData.direccion)} 
                onClick={enviarPedidoCompleto} 
                className="w-full py-5 rounded-3xl font-black text-xs uppercase bg-green-600 disabled:opacity-20 active:scale-95 transition-all"
              >
                {isSubmitting ? 'ENVIANDO...' : 'ENVIAR A COCINA ðŸ”¥'}
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const renderCocina = () => (
    <div className="max-w-7xl mx-auto px-4 pb-20 pt-4 text-white">
      <h1 className="text-3xl font-black italic mb-8 border-l-4 border-orange-600 pl-4 uppercase tracking-tighter">Cocina</h1>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {pedidos.filter(p => p.estado !== 'Listo').map((pedido) => (
          <div key={pedido.id} className="bg-zinc-900 rounded-[40px] p-6 border-t-8 border-orange-600 flex flex-col shadow-2xl">
            <div className="mb-6">
              <span className="text-[10px] font-black px-2 py-1 rounded uppercase bg-white text-black">
                {pedido.tipo === 'local' ? `Mesa ${pedido.mesa}` : pedido.tipo.toUpperCase()}
              </span>
              {pedido.destino && <p className="text-[10px] text-orange-400 font-bold uppercase mt-2 flex items-center gap-1"><MapPin size={10} /> {pedido.destino}</p>}
            </div>
            <div className="flex-grow space-y-4 mb-8">
              {pedido.items.map((it, i) => (
                <div key={i} className="flex gap-3 border-b border-zinc-800 pb-3 last:border-0">
                  <span className="bg-orange-600 text-white text-xs font-black px-2 py-1 rounded-lg h-fit">{it.qty}</span>
                  <div>
                    <span className="text-sm font-bold">{it.name}</span>
                    {it.notes && <p className="text-[11px] text-orange-400 italic"> - {it.notes}</p>}
                  </div>
                </div>
              ))}
            </div>
            <button 
              onClick={() => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'pedidos', pedido.id), { estado: pedido.estado === 'Pendiente' ? 'Preparando' : 'Listo' })} 
              className={`w-full py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest ${pedido.estado === 'Pendiente' ? 'bg-blue-600' : 'bg-green-600'}`}
            >
              {pedido.estado === 'Pendiente' ? 'COMENZAR' : 'LISTO'}
            </button>
          </div>
        ))}
      </div>
    </div>
  );

  const renderCaja = () => {
    const porCobrar = pedidos.filter(p => p.pagoEstado === 'Pendiente');
    const detalle = getDetalleCierre();

    return (
      <div className="max-w-5xl mx-auto px-4 pb-20 pt-4">
        <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6">
          <div>
            <h1 className="text-3xl font-black italic border-l-4 border-green-600 pl-4 uppercase tracking-tighter text-white">Caja Central</h1>
            <p className="text-[10px] text-zinc-500 uppercase mt-1 font-black">Turno actual en curso</p>
          </div>
          <button onClick={() => setShowZReport(true)} className="bg-white text-black px-8 py-4 rounded-3xl text-xs font-black uppercase flex items-center gap-2 shadow-2xl transition-transform active:scale-95">
            <BarChart3 size={18} /> GENERAR CIERRE DETALLADO
          </button>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div className="lg:col-span-2 space-y-4">
            <h3 className="text-xs font-black uppercase text-zinc-500 mb-4 flex items-center gap-2"><ClipboardList size={16}/> Cuentas Pendientes</h3>
            {porCobrar.length === 0 ? (
              <div className="bg-zinc-900/50 p-10 rounded-[32px] border border-dashed border-zinc-800 text-center">
                <p className="text-xs font-bold text-zinc-600 italic">No hay cuentas por cobrar en este momento.</p>
              </div>
            ) : porCobrar.map(p => (
              <div key={p.id} className="bg-zinc-900 p-6 rounded-[32px] flex justify-between items-center border border-zinc-800 hover:border-zinc-700 transition-colors">
                <div className="flex items-center gap-4">
                  <div className={`p-4 rounded-2xl ${p.estado === 'Listo' ? 'bg-green-600 text-white shadow-lg' : 'bg-zinc-800 text-zinc-500'}`}>
                    {p.estado === 'Listo' ? <CheckCircle2 size={20}/> : <Clock size={20}/>}
                  </div>
                  <div>
                    <h4 className="font-black text-base uppercase italic text-white">{p.tipo === 'local' ? `Mesa ${p.mesa}` : p.tipo.toUpperCase()}</h4>
                    <span className="text-[10px] font-bold text-zinc-500 uppercase">Items: {p.items.length}</span>
                  </div>
                </div>
                <div className="flex flex-col items-end gap-2">
                  <span className="text-xl font-black italic text-white">{formatPrice(p.total + (p.costoEnvio || 0))}</span>
                  <button onClick={() => { setPayingOrder(p); setStepPayment('verify'); }} className="bg-green-600 px-6 py-3 rounded-2xl font-black text-[10px] uppercase shadow-lg text-white active:scale-95 transition-all">COBRAR</button>
                </div>
              </div>
            ))}
          </div>

          <div className="space-y-6">
            <h3 className="text-xs font-black uppercase text-zinc-500 mb-4 flex items-center gap-2"><BarChart3 size={16}/> Resumen Parcial</h3>
            <div className="bg-zinc-900 p-6 rounded-[40px] border border-zinc-800 space-y-6">
              <div className="space-y-2">
                <span className="text-[10px] font-black text-zinc-500 uppercase">Ventas Netas</span>
                <p className="text-3xl font-black italic">{formatPrice(detalle.totalVentasBrutas)}</p>
              </div>
              <div className="grid grid-cols-2 gap-4 border-t border-zinc-800 pt-6">
                <div>
                  <span className="text-[9px] font-bold text-zinc-500 uppercase">Propinas</span>
                  <p className="font-black text-green-500">{formatPrice(detalle.propinas)}</p>
                </div>
                <div>
                  <span className="text-[9px] font-bold text-zinc-500 uppercase">Domicilios</span>
                  <p className="font-black text-blue-500">{formatPrice(detalle.envios)}</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        {/* Modal Pago */}
        {payingOrder && (
          <div className="fixed inset-0 z-[150] bg-black/95 flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto">
            <div className="bg-zinc-900 border border-zinc-800 w-full max-w-lg rounded-[48px] p-8 shadow-2xl relative text-white">
              <button onClick={() => setPayingOrder(null)} className="absolute top-6 right-6 bg-zinc-800 p-2 rounded-full hover:bg-zinc-700 transition-colors"><X size={20}/></button>
              
              {stepPayment === 'verify' && (
                <div className="animate-in slide-in-from-bottom duration-300">
                  <h3 className="text-[10px] font-black uppercase tracking-widest text-orange-500 mb-6 flex items-center gap-2"><Receipt size={16}/> Detalle de Cuenta</h3>
                  
                  <div className="bg-zinc-100 text-black p-8 rounded-3xl mb-6 font-mono text-xs shadow-inner">
                    <div className="text-center mb-4 pb-4 border-b border-dashed border-zinc-300">
                      <p className="font-black text-lg">BRAZA BRAVA</p>
                      <p className="font-bold">{payingOrder.tipo === 'local' ? `MESA ${payingOrder.mesa}` : payingOrder.tipo.toUpperCase()}</p>
                    </div>
                    {payingOrder.items.map((it, i) => (
                      <div key={i} className="flex justify-between mb-1">
                        <span>{it.qty}x {it.name}</span>
                        <span>{formatPrice(it.price * it.qty)}</span>
                      </div>
                    ))}
                    <div className="mt-4 pt-4 border-t border-dashed border-zinc-300 space-y-1">
                      <div className="flex justify-between font-bold"><span>Subtotal:</span><span>{formatPrice(payingOrder.total)}</span></div>
                      {payingOrder.costoEnvio > 0 && <div className="flex justify-between"><span>Domicilio:</span><span>{formatPrice(payingOrder.costoEnvio)}</span></div>}
                      {tipAmount > 0 && <div className="flex justify-between text-green-700 font-bold italic"><span>Propina:</span><span>+ {formatPrice(tipAmount)}</span></div>}
                      <div className="flex justify-between text-xl font-black pt-4 border-t border-zinc-200 mt-2"><span>TOTAL:</span><span>{formatPrice(payingOrder.total + tipAmount + (payingOrder.costoEnvio || 0))}</span></div>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-3 mb-6">
                    <div className="col-span-2 text-[10px] font-black uppercase text-zinc-500 mb-1 ml-2">Â¿Propina Voluntaria?</div>
                    <button onClick={() => setTipAmount(payingOrder.total * 0.1)} className={`py-4 rounded-2xl text-[10px] font-black border transition-colors ${tipAmount === payingOrder.total * 0.1 ? 'bg-orange-600 border-orange-600' : 'border-zinc-800 bg-zinc-800 text-zinc-500'}`}>10% ({formatPrice(payingOrder.total * 0.1)})</button>
                    <input type="number" placeholder="Otro valor..." className="bg-zinc-800 rounded-2xl p-4 text-[10px] font-black outline-none border border-zinc-800 focus:border-orange-500 transition-colors" onChange={(e) => setTipAmount(Number(e.target.value))}/>
                  </div>

                  <button onClick={() => setStepPayment('method')} className="w-full bg-green-600 py-5 rounded-3xl font-black text-xs uppercase shadow-lg active:scale-95 transition-all">ELEGIR MÃ‰TODO DE PAGO <ChevronRight className="inline ml-1" size={16}/></button>
                </div>
              )}

              {stepPayment === 'method' && (
                <div className="animate-in slide-in-from-right duration-300">
                  <h3 className="text-2xl font-black italic uppercase mb-8 text-center">MÃ©todo de Pago</h3>
                  <div className="grid grid-cols-2 gap-3 mb-6">
                    <button onClick={() => setStepPayment('cash')} className="flex flex-col items-center gap-3 bg-zinc-800 p-6 rounded-3xl hover:bg-orange-600 transition-all border border-zinc-700 hover:border-orange-400 group">
                      <Wallet size={24} className="group-hover:scale-110 transition-transform"/>
                      <span className="text-[10px] font-black">EFECTIVO</span>
                    </button>
                    <button onClick={() => procesarPago(payingOrder.id, 'Tarjeta')} className="flex flex-col items-center gap-3 bg-zinc-800 p-6 rounded-3xl hover:bg-blue-600 transition-all border border-zinc-700 hover:border-blue-400 group">
                      <CreditCard size={24} className="group-hover:scale-110 transition-transform"/>
                      <span className="text-[10px] font-black">TARJETA</span>
                    </button>
                    <button onClick={() => procesarPago(payingOrder.id, 'QR / Transferencia')} className="flex flex-col items-center gap-3 bg-zinc-800 p-6 rounded-3xl hover:bg-purple-600 transition-all border border-zinc-700 hover:border-purple-400 group">
                      <Smartphone size={24} className="group-hover:scale-110 transition-transform"/>
                      <span className="text-[10px] font-black">QR / TRANSF</span>
                    </button>
                    <button onClick={() => setIsSplitPayment(!isSplitPayment)} className={`flex flex-col items-center gap-3 p-6 rounded-3xl transition-all border ${isSplitPayment ? 'bg-white text-black border-white shadow-xl' : 'bg-zinc-800 text-white border-zinc-700 hover:border-zinc-500'}`}>
                      <Split size={24} />
                      <span className="text-[10px] font-black">COMBINADO</span>
                    </button>
                  </div>

                  {isSplitPayment && (
                    <div className="bg-white/5 p-6 rounded-3xl space-y-4 border border-zinc-700 animate-in zoom-in duration-200">
                      <p className="text-[10px] font-black uppercase text-orange-500 text-center tracking-widest">Configurar Pago Combinado</p>
                      <div>
                        <span className="text-[9px] font-bold text-zinc-500 uppercase ml-2">Â¿CuÃ¡nto pagan en Efectivo?</span>
                        <input type="number" className="bg-zinc-800 w-full p-4 rounded-2xl text-xl font-black mt-1 outline-none border border-zinc-700" placeholder="0" value={splitCashAmount} onChange={(e) => setSplitCashAmount(Number(e.target.value))}/>
                      </div>
                      <div className="grid grid-cols-2 gap-2">
                        <button onClick={() => procesarPago(payingOrder.id, 'Combinado', { efectivo: splitCashAmount, otro: 'Tarjeta' })} className="bg-blue-600 p-4 rounded-xl text-[9px] font-black uppercase shadow-lg">Resto Tarjeta</button>
                        <button onClick={() => procesarPago(payingOrder.id, 'Combinado', { efectivo: splitCashAmount, otro: 'Transferencia' })} className="bg-purple-600 p-4 rounded-xl text-[9px] font-black uppercase shadow-lg">Resto Transf</button>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {stepPayment === 'cash' && (
                <div className="text-center animate-in slide-in-from-right">
                  <div className="bg-black/40 p-10 rounded-3xl border border-zinc-800 mb-8 shadow-inner">
                    <span className="text-[10px] font-black uppercase opacity-50 block mb-2 tracking-widest">Efectivo Recibido</span>
                    <input type="number" autoFocus className="bg-transparent text-6xl font-black text-white outline-none w-full text-center placeholder-zinc-800" placeholder="0" onChange={(e) => setCashReceived(e.target.value)} />
                  </div>
                  <div className="mb-10">
                    <span className="text-[10px] uppercase font-black text-orange-500 block mb-1 tracking-widest italic">Cambio a entregar</span>
                    <h3 className="text-5xl font-black text-white italic">{formatPrice(Math.max(0, Number(cashReceived) - (payingOrder.total + tipAmount + (payingOrder.costoEnvio || 0))))}</h3>
                  </div>
                  <button onClick={() => procesarPago(payingOrder.id, 'Efectivo')} className="w-full bg-green-600 py-6 rounded-3xl font-black text-sm uppercase shadow-2xl active:scale-95 transition-all">CONFIRMAR PAGO RECIBIDO ðŸ”¥</button>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Cierre de Caja Detallado */}
        {showZReport && (
          <div className="fixed inset-0 z-[200] bg-black/98 flex items-center justify-center p-4 backdrop-blur-md overflow-y-auto">
            <div className="bg-zinc-50 text-black w-full max-w-lg rounded-[48px] p-8 font-mono shadow-2xl relative my-8">
              <button onClick={() => setShowZReport(false)} className="absolute top-6 right-6 bg-zinc-200 p-2 rounded-full hover:bg-zinc-300 transition-colors"><X size={18}/></button>
              
              <div className="text-center mb-8 border-b border-zinc-300 pb-6">
                <h3 className="text-2xl font-black italic uppercase tracking-tighter">CIERRE DETALLADO</h3>
                <div className="flex items-center justify-center gap-2 mt-1 text-zinc-500 font-bold text-[10px]">
                  <CalendarDays size={12}/> {new Date().toLocaleDateString()} | <Clock size={12}/> {new Date().toLocaleTimeString()}
                </div>
              </div>

              <div className="space-y-6 mb-8 overflow-y-auto max-h-[60vh] pr-2 scrollbar-hide">
                {/* Ingresos Base y Efectivo */}
                <div className="bg-white p-6 rounded-3xl border border-zinc-200 shadow-sm">
                  <span className="text-[10px] font-black uppercase text-zinc-400 block mb-4 border-b border-zinc-100 pb-2">Control de Efectivo</span>
                  <div className="flex justify-between items-center mb-4">
                    <span className="text-xs font-bold">Base Caja:</span>
                    <div className="flex items-center gap-2 bg-zinc-100 px-3 py-1 rounded-xl">
                      <span className="font-black">$</span>
                      <input type="number" className="font-black outline-none w-20 bg-transparent text-right" value={cajaBase} onChange={(e) => setCajaBase(Number(e.target.value))}/>
                    </div>
                  </div>
                  <div className="flex justify-between items-center mb-4">
                    <span className="text-xs font-bold">Ventas Efectivo:</span>
                    <span className="font-black text-zinc-700">{formatPrice(detalle.efectivo)}</span>
                  </div>
                  <div className="bg-zinc-900 text-white p-4 rounded-2xl flex justify-between items-center mt-2">
                    <span className="text-[10px] font-black uppercase">Efectivo Total en Caja:</span>
                    <span className="text-lg font-black italic">{formatPrice(cajaBase + detalle.efectivo)}</span>
                  </div>
                </div>

                {/* Otros Medios */}
                <div className="bg-white p-6 rounded-3xl border border-zinc-200 shadow-sm">
                  <span className="text-[10px] font-black uppercase text-zinc-400 block mb-4 border-b border-zinc-100 pb-2">Otros Medios de Pago</span>
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-xs font-bold text-blue-600">Tarjetas:</span>
                    <span className="font-black">{formatPrice(detalle.tarjeta)}</span>
                  </div>
                  <div className="flex justify-between items-center">
                    <span className="text-xs font-bold text-purple-600">Transferencias:</span>
                    <span className="font-black">{formatPrice(detalle.transferencia)}</span>
                  </div>
                </div>

                {/* Desglose Ventas CategorÃ­a */}
                <div className="bg-white p-6 rounded-3xl border border-zinc-200 shadow-sm">
                  <span className="text-[10px] font-black uppercase text-zinc-400 block mb-4 border-b border-zinc-100 pb-2">Ventas por CategorÃ­a</span>
                  <div className="space-y-2">
                    {Object.entries(detalle.categoriasContador).map(([cat, qty]) => (
                      <div key={cat} className="flex justify-between text-xs font-bold">
                        <span className="text-zinc-600">{cat}:</span>
                        <span className="font-black">{qty} unds</span>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Resumen Adicionales */}
                <div className="bg-orange-50 p-6 rounded-3xl border border-orange-100">
                  <span className="text-[10px] font-black uppercase text-orange-400 block mb-4 border-b border-orange-200 pb-2 text-center">Resumen del Turno</span>
                  <div className="space-y-2">
                    <div className="flex justify-between text-xs"><span>Venta Bruta:</span><span className="font-bold">{formatPrice(detalle.totalVentasBrutas)}</span></div>
                    <div className="flex justify-between text-xs"><span>Propinas:</span><span className="font-bold text-green-600">+ {formatPrice(detalle.propinas)}</span></div>
                    <div className="flex justify-between text-xs"><span>EnvÃ­os:</span><span className="font-bold text-blue-600">+ {formatPrice(detalle.envios)}</span></div>
                    <div className="flex justify-between text-base font-black border-t border-orange-200 pt-3 mt-2">
                      <span>VENTA TOTAL:</span>
                      <span className="italic">{formatPrice(detalle.totalVentasNetas)}</span>
                    </div>
                  </div>
                </div>

                <div className="bg-white p-4 rounded-3xl border border-zinc-200 shadow-sm">
                  <span className="text-[10px] font-black uppercase text-zinc-400 block mb-2 flex items-center gap-2"><MessageSquareText size={14}/> Novedades del Turno</span>
                  <textarea className="w-full bg-zinc-50 p-3 rounded-xl text-[11px] outline-none h-24 resize-none border border-zinc-100 font-sans" placeholder="Describe cualquier novedad relevante..." value={zComments} onChange={(e) => setZComments(e.target.value)}></textarea>
                </div>
              </div>

              <div className="flex flex-col gap-3">
                <button onClick={enviarCierreWhatsApp} className="w-full bg-green-600 text-white py-5 rounded-3xl font-black text-xs uppercase flex items-center justify-center gap-3 shadow-xl active:scale-95 transition-all">
                  <MessageCircle size={20}/> ENVIAR REPORTE A WHATSAPP
                </button>
                <button onClick={() => window.print()} className="w-full bg-zinc-900 text-white py-5 rounded-3xl font-black text-xs uppercase flex items-center justify-center gap-3 shadow-lg hover:bg-black transition-colors">
                  <Printer size={20}/> IMPRIMIR TICKET DE CIERRE
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-black text-white font-sans selection:bg-orange-500">
      <audio ref={audioNuevoRef} src={SOUND_NUEVO_PEDIDO} preload="auto" />
      <audio ref={audioListoRef} src={SOUND_PEDIDO_LISTO} preload="auto" />
      
      <nav className="fixed bottom-0 left-0 w-full bg-zinc-950/90 backdrop-blur-xl border-t border-zinc-900 z-[100] px-6 py-5 flex justify-around md:top-0 md:bottom-auto md:justify-center md:gap-32">
        <button onClick={() => setView('cliente')} className={`flex flex-col items-center gap-1 transition-all ${view === 'cliente' ? 'text-orange-500 scale-110' : 'text-zinc-600 hover:text-zinc-400'}`}>
          <PlusCircle size={24} /><span className="text-[9px] font-black uppercase">Nuevo Pedido</span>
        </button>
        <button onClick={() => setView('cocina')} className={`relative flex flex-col items-center gap-1 transition-all ${view === 'cocina' ? 'text-orange-500 scale-110' : 'text-zinc-600 hover:text-zinc-400'}`}>
          <ChefHat size={24} />
          {pedidos.filter(p => p.estado === 'Pendiente').length > 0 && <span className="absolute -top-1 -right-1 bg-red-600 w-2.5 h-2.5 rounded-full animate-pulse border-2 border-black"></span>}
          <span className="text-[9px] font-black uppercase">Cocina</span>
        </button>
        <button onClick={() => setView('caja')} className={`flex flex-col items-center gap-1 transition-all ${view === 'caja' ? 'text-green-500 scale-110' : 'text-zinc-600 hover:text-zinc-400'}`}>
          <Receipt size={24} /><span className="text-[9px] font-black uppercase">Caja</span>
        </button>
      </nav>

      <main className="pt-2 md:pt-32 min-h-screen">
        {!user ? (
          <div className="h-[80vh] flex flex-col items-center justify-center">
            <Flame className="animate-pulse text-orange-600" size={60}/><p className="text-[10px] font-black mt-4 uppercase tracking-widest opacity-40">Cargando Braza Brava...</p>
          </div>
        ) : (
          <div className="animate-in fade-in duration-700">
            {view === 'cliente' ? renderCliente() : view === 'cocina' ? renderCocina() : renderCaja()}
          </div>
        )}
      </main>
    </div>
  );
}